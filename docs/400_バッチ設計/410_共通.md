# バッチ設計:共通

## 起動

- トリガー
    - APIへのリクエストに応答して起動する。
    ```
    curl \
      -X POST https://emolab.jp/api/galz6dge/modify_articles
      --key=aw4e54r65t7yghujiko
    ```

- 定時
    - ジョブスケジューラで一日一回上記のリクエストを送信する。
        - 処理日時: 毎日01:00


## 処理手順

1. はてなブログから最新7件の記事データを取得する。
    ```
    curl \
      -X GET https://blog.hatena.ne.jp/{はてなID}/{ブログID}/atom/entry
      -u {はてなID}:{APIキー}
    ```

2. `articles`テーブルに記事が登録されているかどうか確認する。
    - entry_idで検索してヒットしなかった場合、登録対象とみなす。
    - updatedが一致しなかった場合、更新対象とみなす。

3. 登録対象・更新対象となった記事を`articles`テーブルに登録・更新する。
    - 登録対象の場合: 記事データをinsertする。更新済みフラグはFalseにする。
    - 更新対象の場合: 更新済フラグをFalseにupdateする。

4. 登録・更新対象ではない記事が存在しない場合は、次の7件を取得して再度2～3を実行する。
    ```
    curl \
      -X GET https://blog.hatena.ne.jp/{はてなID}/{ブログID}/atom/entry?page=12345678912
      -u {はてなID}:{APIキー}
    ```

5. ETL処理を実行する。
    - 処理手順については各種ETLのバッチ設計に従う。
    - 実行対象のETLは設定ファイルに記載しておく。

6. `logs`テーブルを走査してエラー有無を確認する。

7. 処理結果をメール通知する。

## エラー対応

- はてなブログから記事を取得できなかった場合
    - 下記メッセージをメール通知し、処理を中断する。
    ```
    予期せぬエラーが発生し、はてなブログから記事を取得できませんでした。
    詳しい内容はログを確認してください。
    ```

- その他のエラーが発生した場合
    - 下記メッセージをメール通知し、処理を中断する。
    ```
    サーバーエラーが発生したので処理を中断しました。
    ```

## メール本文

- 登録・更新対象がある場合
    ```
    galz6dge バッチ処理結果

    下記の記事は更新処理が正常終了しました。
    ・{entry_id}:タイトル１
    https://{ルートURL}/entry/2024/01/01/100000
    ・{entry_id}:タイトル２
    https://{ルートURL}/entry/2024/01/01/110000
    ...

    下記の記事は更新処理が異常終了しました。
    ・{entry_id}:タイトル３
    エラーメッセージ３．１
    エラーメッセージ３．２
    ・{entry_id}:タイトル４
    エラーメッセージ
    ...
    ```

- 登録・更新対象がない場合
    ```
    galz6dge バッチ処理結果

    更新対象の記事がありませんでした。
    ```
