# 共通

## 目的

- 記事執筆をなるべく短くするため定型処理を自動化したい。
- はてなブログで用意されていない処理を定期夜間バッチとして実装する。

## 業務要件

- 記事を投稿・更新する。（はてなブログ）
- 記事を自動整形する。（本システム）
  - はてなブログAPIから記事データを取得する。
  - 記事データを整形する。
  - 整形済みの記事データではてなブログの記事を更新する。

## 機能要件

- はてなブログAPIを使って以下の操作を実行する。
  - 記事データを取得する。（GET）
    - 最新7件の記事を取得する。
    - 取得結果のうち整形不要の記事が存在しない場合は次の7件を取得する。
  - 記事データを整形する。（本システム内部処理）
    - 目的に応じて整形処理を差し替えできるようにする。
    - 整形処理の要件については各バッチ処理の要件定義に従う。
  - 記事データを更新する。（PATCH）
    - エラーが発生した場合は、その記事の更新をスキップする。
    - 更新成功した記事と失敗した記事を一覧化してメール通知する。
- 一日一回、本システムのAPIを実行する。
  - 処理の流れは、1:記事取得、2:記事整形、3:記事更新。
  - 処理を実行するタイミングは可変とする。
    - デフォルトは深夜1:00。
  
## 非機能要件

- 可用性
  - ブログシステムの可用性ははてなブログの仕様に準ずる。
  - 記事整形終了時の`メール通知`で不具合発生を検知する。
    - 更新対象のブログURLを記載する。
    - 更新対象が無い場合もメール通知する。
    - メール通知が無い場合は不具合発生を疑う。
- 性能・拡張性
  - `夜1時`に開始し、`夜4時`までに処理を完了させる。
  - 1記事あたりの処理時間が長い場合は複数のバッチに分けることを検討する。
    - 共通DBを参照し、独立したAPサーバーを立てる。
- 運用・保守性
  - 夜1時～4時以外の時間帯にメンテナンスを行う。
  - 記事整形ミスのリカバリのために、`整形前の記事バックアップ`を作成する。
- 移行性
  - 夜間バッチを分けている場合は、個別に技術設計してサービスを新規構築する。
  - 共通のDBを使うため、RDBMSを変更する場合は全サービスについて変更内容を反映させる。
- セキュリティ
  - 個人情報はなるべく保持せず、会員登録を要しないシステムを設計する。
  - `APIキー`をリクエストヘッダに付与し、環境変数の値と一致した場合のみAPI処理を実行する。
  - メール通知によって想定外のAPIアクセスを検知する。
- システム環境・エコロジー
  - 本システムを利用できるのは特定のユーザーのみ。
    - ユーザーごとにサーバー構築して独自サービスとして運用するものとする。
    - 利用申請に応じて新規ユーザーにサービス構築方法を伝授する。
  - 必要に応じて様々なサーバー構成に対応できるようにする。
    - 最初は`VPS & MySQL`で構築する。
    - 需要があれば`Lambda & MongoDB`なども採用できるようにする。

